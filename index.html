<!DOCTYPE html>
<html>

<head>
	<title>Discord Guild Limit Checker</title>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<style>
		html {
			background: #36393f no-repeat url(https://canary.discordapp.com/assets/14c037b7102f18b2d2ccf065a52bb595.jpg);
		}

		* {
			font-size: 5vw;
			text-align: center;
			color: #dfdfdf;
		}
	</style>

	<script type="text/javascript">
		const redirectUrl = "https://discordapp.com/api/oauth2/authorize?response_type=token&client_id=679783114435854346&scope=guilds";
		var state = 0;
		var checkClosedInterval;

		const getGuilds = async (userType, token) => {
			const response = await fetch('https://discordapp.com/api/v6/users/@me/guilds', {
				headers: {
					"Authorization": `${userType} ${token}`
				}
			});
			return response.json();
		}

		if (window.opener) {
			window.opener.countGuilds(location.hash);
			window.close();
		}
	</script>
</head>

<body>
	<p id="result">Redirecting...</p>


	<script>
		let hash;
		if (location.hash === "") {

			var newWin = window.open(redirectUrl, "GuildLimitWindow", "menubar=no,toolbar=no,location=yes,personalbar=no,dependent=yes,minimizable=no,scrollbars=no,dialog=yes,width=480,height=780");
			state = 1;
			if (!newWin || newWin.closed || typeof newWin.closed == 'undefined') {
				location = redirectUrl;
				document.write(`<meta http-equiv="Refresh" content="0; url=${redirectUrl}"">`);
			} else {
				document.getElementById("result").innerHTML = "Waiting for authorization...";
				checkClosedInterval = setInterval(() => {
					if (state != 1)
						clearInterval(checkClosedInterval);
					if (state == 1 && (!newWin || newWin.closed || typeof newWin.closed == 'undefined')) {
						state = 3;
						document.getElementById("result").innerHTML = "Authorization failed";
						clearInterval(checkClosedInterval);
					}
				}, 100);
			}
		} else {
			countGuilds(location.hash);
		}

		function countGuilds(hash) {
			state = 2;
			history.replaceState(null, "Discord Guild Limit Checker", "#");

			let userType = new RegExp("token_type=(.+?)&").exec(hash)[1];
			let token = new RegExp("access_token=(.+?)&").exec(hash)[1];

			document.getElementById("result").innerHTML = "Fetching data...";

			getGuilds(userType, token).then(response => {
				resp = response;
				let num = response.length;
				document.getElementById("result").innerHTML = "You are in " + num + "/100 guilds!";
			});
		}
	</script>
</body>

</html>